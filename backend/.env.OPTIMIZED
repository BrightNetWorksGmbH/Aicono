# MongoDB Connection Pool Configuration - OPTIMIZED
#
# CRITICAL: These settings fix the high connection pool usage issue
# Apply these changes to your .env file

# ðŸ”¥ IMMEDIATE FIX: Increase pool size temporarily while other optimizations are applied
# Previous: MONGODB_MAX_POOL_SIZE=100
# New: Increase to 150 to handle 20 buildings + aggregation + API requests
MONGODB_MAX_POOL_SIZE=150

# Keep minimum connections alive (reduced from 10 to conserve resources when idle)
MONGODB_MIN_POOL_SIZE=5

# Connection pool priority system (keep enabled)
MONGODB_PRIORITY_SYSTEM_ENABLED=true
MONGODB_HIGH_PRIORITY_RESERVED=30  # Increased from 20 to ensure real-time data always has connections

# Measurement Queue Configuration - OPTIMIZED
# Batch size for processing measurements (increased for efficiency)
MEASUREMENT_QUEUE_BATCH_SIZE=200  # Previously 50, now 200 for better throughput

# Processing interval in milliseconds (how often queue is processed)
MEASUREMENT_QUEUE_INTERVAL=1000  # 1 second (keep current value)

# Maximum queue size per building (prevent memory issues)
MEASUREMENT_QUEUE_MAX_SIZE=20000  # Increased from 10000 to handle bursts

# Measurement queue throttling (when to reduce processing due to API load)
API_REQUEST_THRESHOLD=5  # Reduce measurement processing when >5 API requests active
MEASUREMENT_QUEUE_THROTTLE_FACTOR=0.5  # Process at 50% speed when throttled

# Aggregation Configuration - OPTIMIZED
# Enable aggregation job queue to prevent overlapping aggregations
AGGREGATION_QUEUE_ENABLED=true
AGGREGATION_QUEUE_MAX_CONCURRENT=1  # Only one aggregation at a time

# Delete raw data after aggregation (recommended for storage efficiency)
DELETE_RAW_AFTER_AGGREGATION=true

# Safety buffer: keep raw data for at least N minutes after aggregation
# This prevents deleting data that's still being written
RAW_DATA_BUFFER_MINUTES=30

# Old data retention for safety cleanup job (in days)
# This is a fallback - most data should be deleted immediately after aggregation
OLD_DATA_RETENTION_DAYS=1

# Deletion Queue Configuration - OPTIMIZED
# Batch size for deletion operations (increased for efficiency)
DELETION_QUEUE_BATCH_SIZE=50000  # Large batches for efficient deletion

# Processing interval in milliseconds
DELETION_QUEUE_INTERVAL=2000  # Check every 2 seconds

# Maximum pool usage threshold for deletion operations
DELETION_QUEUE_MAX_POOL_USAGE=85  # Don't run deletions if pool >85% used

# ðŸ”¥ NEW: Structure Loading Configuration
# These settings prevent repeated structure loading
# (These are used by the optimized loxoneStorageService.js)
STRUCTURE_LOAD_COOLDOWN=60000  # Don't reload structure more than once per minute (milliseconds)
SENSOR_CACHE_TTL=300000  # Cache sensor data for 5 minutes (milliseconds)
